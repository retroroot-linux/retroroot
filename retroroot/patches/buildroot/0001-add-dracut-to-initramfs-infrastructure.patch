From 6cbd89b29fc8cff5ceceaa26ab1da8e53efdd0c3 Mon Sep 17 00:00:00 2001
From: Adam Duskett <Aduskett@rivian.com>
Date: Fri, 26 Feb 2021 15:57:18 -0800
Subject: [PATCH] Add dracut to initramfs infrastructure

Signed-off-by: Adam Duskett <Aduskett@gmail.com>
---
 fs/initramfs/Config.in    |  2 +-
 fs/initramfs/initramfs.mk | 19 +++++++++++++++----
 linux/linux.mk            |  5 +++++
 3 files changed, 21 insertions(+), 5 deletions(-)

diff --git a/fs/initramfs/Config.in b/fs/initramfs/Config.in
index 9d5a3f92e6..3ead5a1ceb 100644
--- a/fs/initramfs/Config.in
+++ b/fs/initramfs/Config.in
@@ -1,7 +1,7 @@
 config BR2_TARGET_ROOTFS_INITRAMFS
 	bool "initial RAM filesystem linked into linux kernel"
 	depends on BR2_LINUX_KERNEL
-	select BR2_TARGET_ROOTFS_CPIO
+	select BR2_TARGET_ROOTFS_CPIO if !BR2_TARGET_ROOTFS_DRACUT
 	help
 	  Integrate the root filesystem generated by Buildroot as an
 	  initramfs inside the kernel image. This integration will
diff --git a/fs/initramfs/initramfs.mk b/fs/initramfs/initramfs.mk
index 3b3d4ed8b9..40ed85d063 100644
--- a/fs/initramfs/initramfs.mk
+++ b/fs/initramfs/initramfs.mk
@@ -21,9 +21,6 @@
 
 rootfs-initramfs: linux-rebuild-with-initramfs
 
-rootfs-initramfs-show-depends:
-	@echo rootfs-cpio
-
 .PHONY: rootfs-initramfs rootfs-initramfs-show-depends
 
 ifeq ($(BR2_TARGET_ROOTFS_INITRAMFS),y)
@@ -33,4 +30,18 @@ endif
 # Not using the rootfs infra, so fake the variables
 ROOTFS_INITRAMFS_NAME = rootfs-initramfs
 ROOTFS_INITRAMFS_TYPE = rootfs
-ROOTFS_INITRAMFS_DEPENDENCIES = rootfs-cpio linux
+ROOTFS_INITRAMFS_DEPENDENCIES = linux
+
+ifeq ($(BR2_TARGET_ROOTFS_CPIO),y)
+ROOTFS_INITRAMFS_DEPENDENCIES += rootfs-cpio
+rootfs-initramfs-show-depends:
+	@echo rootfs-cpio
+
+endif
+
+ifeq ($(BR2_TARGET_ROOTFS_DRACUT),y)
+ROOTFS_INITRAMFS_DEPENDENCIES += rootfs-dracut
+rootfs-initramfs-show-depends:
+	@echo rootfs-dracut
+endif
+
diff --git a/linux/linux.mk b/linux/linux.mk
index 5e4b319cf1..f0a14bf69f 100644
--- a/linux/linux.mk
+++ b/linux/linux.mk
@@ -579,7 +579,12 @@ $(eval $(kconfig-package))
 .PHONY: linux-rebuild-with-initramfs
 linux-rebuild-with-initramfs: $(LINUX_DIR)/.stamp_target_installed
 linux-rebuild-with-initramfs: $(LINUX_DIR)/.stamp_images_installed
+ifeq ($(BR2_TARGET_ROOTFS_CPIO),y)
 linux-rebuild-with-initramfs: rootfs-cpio
+endif
+ifeq ($(BR2_TARGET_ROOTFS_DRACUT),y)
+linux-rebuild-with-initramfs: rootfs-dracut
+endif
 linux-rebuild-with-initramfs:
 	@$(call MESSAGE,"Rebuilding kernel with initramfs")
 	# Build the kernel.
-- 
2.25.1

